
@using WebApp_Mini_Project.ViewModels
@model PostViewModel


<head>
    <link rel="stylesheet" href="~/css/style_Post.css">
    
</head>

<main class="main-container">
    <section class="search-section">
        <h2>หาเพื่อนเล่นเกมส์ดีที่สุดในประเทศไทย</h2>
        <input type="text" placeholder="พิมพ์เพื่อค้นหา..." class="search-bar">
    </section>

    <button class="refresh-btn" id="openPopupBtn">Posts</button>
    <!-- Popup Form -->
    <div class="popup-background" id="popup">
        <div class="popup-form">
            <h3>กรอกข้อมูลห้อง</h3>
            <form method="POST" asp-controller="Post" asp-action="Create">
                <label asp-for="NewPost.Id_room">ชื่อห้อง:</label>
                <input type="text" asp-for="NewPost.Id_room">


                <label asp-for="NewPost.Game">เกม:</label>
                <select asp-for="NewPost.Game">
                    <option value="Valorant">Valorant</option>
                    <option value="PUBG">PUBG</option>
                    <option value="Dota2">Dota2</option>
                    <option value="Rov">Rov</option>
                </select>

                <label asp-for="NewPost.Details">รายละเอียด:</label>
                <input type="text" asp-for="NewPost.Details">

                <label asp-for="NewPost.Max_person">จำนวนสมาชิก:</label>
                <select asp-for="NewPost.Max_person">
                    <option value="1">1 คน</option>
                    <option value="2">2 คน</option>
                    <option value="3">3 คน</option>
                    <option value="4">4 คน</option>
                </select>

                <label for="duration">ระยะเวลา:</label>
                <select id="duration" name="duration">
                    <option value="1">1 ชั่วโมง</option>
                    <option value="2">2 ชั่วโมง</option>
                    <option value="3">3 ชั่วโมง</option>
                </select>

                <button type="submit">ยืนยัน</button>
            </form>
            <div class="close-popup" id="closePopup">ปิด</div>
        </div>
    </div>

    
    <div class="card-container" id="card-container">
        @foreach (var post in Model.Posts)
        {
        <div class="card-container" id="card-container">
                <div class="card">
                    <img src="https://w0.peakpx.com/wallpaper/16/995/HD-wallpaper-valorant-logo.jpg" alt="logo" class="card-logo">
                    <div class="card-content">
                        <p>เลขห้อง: @post.Id_room</p>
                        <p>รายละเอียด: @post.Details</p>
                        <p>เกม: @post.Game</p>
                        <div class="status">
                           
                            <span id="person-count-@post.ID">@post.Count_person/@post.Max_person</span>
                        </div>
                    </div>
                    <button class="card-button join-room-button" data-id="@post.ID">
                        เข้าร่วม
                    </button>
            </div>
        </div>
            
        }
    </div>

    
    <div class="floating-button" onclick="toggleChatPopup()">
        <img src="https://png.pngtree.com/png-clipart/20190617/original/pngtree-chat-vector-icon-png-image_3876224.jpg" alt="icon">
    </div>

    <div class="chat-popup" id="chatPopup">
        <div class="chat-popup-header">
            แชทแจ้งเตือน
        </div>
        <div class="chat-popup-body" id="chatBody">
            @* ข้อความแชท  *@
        </div>
    </div>

</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // ตรวจสอบข้อมูล Count_person ว่ามากกว่าหรือเท่ากับ Max_person ไหมเมื่อเปิดหน้าเว็บ
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".card-container").forEach(function (container) {
            var countSpan = container.querySelector(".status span");
            var button = container.querySelector(".card-button");

            var countMax = countSpan.textContent.split('/').map(Number);
            var countPerson = countMax[0];
            var maxPerson = countMax[1];

            if (countPerson >= maxPerson) {
                button.style.backgroundColor = "red";
                button.style.pointerEvents = "none";
                button.style.cursor = "not-allowed";
                button.style.opacity = "0.6";
            }
        });
    });


    $(document).ready(function () {
        $('.join-room-button').click(function (e) {
            e.preventDefault(); // หยุดการทำงานของลิงก์ปกติ

            var button = $(this); // เก็บการอ้างอิงถึงปุ่มที่คลิก
            var postId = button.data('id');
            var personCountSpan = $('#person-count-' + postId);
            var personCountText = personCountSpan.text();
            var currentCount = parseInt(personCountText.split('/')[0]);
            var maxPerson = parseInt(personCountText.split('/')[1]);

            // ตรวจสอบว่า จำนวนคนในห้องเกินหรือตรงกับ Max_person หรือไม่
            if (currentCount >= maxPerson) {
                // เปลี่ยนลักษณะของปุ่มเพื่อทำให้เป็นสีแดงและไม่สามารถคลิกได้
                button.css({
                    'background-color': 'red',     // เปลี่ยนสีพื้นหลังเป็นสีแดง
                    'pointer-events': 'none',       // ป้องกันการคลิก
                    'cursor': 'not-allowed',        // เปลี่ยนเคอร์เซอร์เป็นไม่อนุญาต
                    'opacity': '0.6'                // ทำให้ปุ่มโปร่งแสง
                });
                return; // หยุดการทำงานของฟังก์ชันหากห้องเต็ม
            }

            $.ajax({
                url: '@Url.Action("Joinroom", "Post")',
                type: 'POST',
                data: { id: postId },
                success: function (response) {
                    if (response.success) {
                        var newCount = response.newCount;
                        personCountSpan.text(newCount + '/' + maxPerson);

                        // ตรวจสอบอีกครั้งเพื่ออัปเดตสถานะปุ่ม
                        if (newCount >= maxPerson) {
                            button.css({
                                'background-color': 'red',     // เปลี่ยนสีพื้นหลังเป็นสีแดง
                                'pointer-events': 'none',       // ป้องกันการคลิก
                                'cursor': 'not-allowed',        // เปลี่ยนเคอร์เซอร์เป็นไม่อนุญาต
                                'opacity': '0.6'                // ทำให้ปุ่มโปร่งแสง
                            });
                        }
                    } else {
                        alert('เกิดข้อผิดพลาด!');
                    }
                },
            });
        });
    });
</script>
<script src="~/js/script_Post.js"></script>

