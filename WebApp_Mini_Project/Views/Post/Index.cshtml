
@using WebApp_Mini_Project.ViewModels
@model PostViewModel


<head>
    <link rel="stylesheet" href="~/css/style_Post.css">
    
</head>

<main class="main-container">
    <section class="search-section">
        <h2>หาเพื่อนเล่นเกมส์ดีที่สุดในประเทศไทย</h2>
        <input type="text" placeholder="พิมพ์เพื่อค้นหา..." class="search-bar">
    </section>

    <button class="refresh-btn" id="openPopupBtn"><span>Posts</span></button>
    <!-- Popup Form -->
    <div class="popup-background" id="popup">
        <div class="popup-form">
            <h3>กรอกข้อมูลห้อง</h3>
            <form method="POST" asp-controller="Post" asp-action="Create">
                <label asp-for="NewPost.Name_room">ชื่อห้อง :</label>
                <input type="text" asp-for="NewPost.Name_room">
                <label asp-for="NewPost.Id_room">เลขห้อง :</label>
                <input type="text" asp-for="NewPost.Id_room">


                <label asp-for="NewPost.Game">เกม :</label>
                <select asp-for="NewPost.Game">
                    <option value="Valorant">Valorant</option>
                    <option value="PUBG">PUBG</option>
                    <option value="Dota2">Dota2</option>
                    <option value="Rov">Rov</option>
                </select>

                <label asp-for="NewPost.Details">รายละเอียด :</label>
                <input type="text" asp-for="NewPost.Details">

                <label asp-for="NewPost.Max_person">จำนวนสมาชิก :</label>
                <select asp-for="NewPost.Max_person">
                    <option value="1">1 คน</option>
                    <option value="2">2 คน</option>
                    <option value="3">3 คน</option>
                    <option value="4">4 คน</option>
                </select>

                <label for="duration">ระยะเวลา :</label>
                <select id="duration" name="duration">
                    <option value="1">1 ชั่วโมง</option>
                    <option value="2">2 ชั่วโมง</option>
                    <option value="3">3 ชั่วโมง</option>
                </select>

                <button type="submit">ยืนยัน</button>
            </form>
            <div class="close-popup" id="closePopup">ปิด</div>
        </div>
    </div>


    <div class="card-container" id="card-container">
        @foreach (var post in Model.Posts)
        {
            <div class="card-container" id="card-container">
                <div class="card">
                    @{
                        int ID = 0;
                        if (ViewBag.UserID != null)
                        {
                             ID = ViewBag.UserID;
                        }
                        

                        if (post.User_Picture != null)
                        {
                            var base64String = Convert.ToBase64String(post.User_Picture);
                            var imgSrc = $"data:image/jpeg;base64,{base64String}";
                            <img src="@imgSrc" alt="logo" class="card-logo" />
                        }
                        else
                        {
                            <img src="~/Image/User_icon.png" alt="logo" class="card-logo" />
                        }
                    }
                    <div class="card-content">
                        @foreach (var account in Model.Account)
                        {
                            if (account.ID == post.User_id)
                            {
                                <p id="user"> @account.Username</p>
                            }
                        }
                        <p><b>ชื่อห้อง</b> : @post.Name_room</p>
                        <p><b>เกม</b> : @post.Game</p>
                        <p><b>รายละเอียด</b> : @post.Details</p>
                    </div>
                    @if (post.User_list.Contains(ID))
                    {
                        <button class="card-button join-room-button" data-id="@post.ID" disabled style="opacity: 0.6; cursor: default;">
                            <span id="person-count-@post.ID">@post.Count_person/@post.Max_person</span>
                        </button>
                    }
                    else if (post.User_id != ViewBag.UserID)
                    {
                        <button class="card-button join-room-button" data-id="@post.ID">
                            <span id="person-count-@post.ID">@post.Count_person/@post.Max_person</span>
                        </button>
                    }
                    else
                    {
                        <button class="card-button join-room-button" data-id="@post.ID" disabled style="background-color: white; color:black; cursor: default; ">
                            <span id="person-count-@post.ID">@post.Count_person/@post.Max_person</span>
                        </button>
                    }


                </div>
            </div>

        }
    </div>


    <div class="floating-button" onclick="toggleChatPopup()">
        <img src="https://png.pngtree.com/png-clipart/20190617/original/pngtree-chat-vector-icon-png-image_3876224.jpg" alt="icon">
    </div>

    <div class="chat-popup" id="chatPopup">
        <div class="chat-popup-header">
            แชทแจ้งเตือน
        </div>
        <div class="chat-popup-body" id="chatBody">
            @* ข้อความแชท  *@
        </div>
    </div>

</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    const popupBtn = document.getElementById('openPopupBtn'); // ปุ่มเปิด form
    const closePopup = document.getElementById('closePopup'); // ปุ่มปิด form
    const userSession = '@ViewBag.Usersession'; // session
    const popup = document.getElementById('popup'); // form

    // ฟังก์ชั่นเปิด Form Post
    popupBtn.addEventListener('click', function () {
        if (!userSession) { // เช็คว่ามี session ในระบบไหม
            window.location.href = '/Account/Login'; //ถ้าไม่มีจะให้ไป login
        } else {
            popup.style.display = 'flex'; // ถ้ามีจะให้เปิด form
        }
    });
    // ฟังก์ชั่นปิด Form Post
    closePopup.addEventListener('click', function () {
        popup.style.display = 'none';
    });

    //---------------------------------------------------------------------------------------------------


    // ตรวจสอบข้อมูล Count_person ว่ามากกว่าหรือเท่ากับ Max_person ไหมเมื่อเปิดหน้าเว็บ
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".card-container").forEach(function (container) {
            var countSpan = container.querySelector(".card-button");
            var button = container.querySelector(".card-button");

            var countMax = countSpan.textContent.split('/').map(Number);
            var countPerson = countMax[0];
            var maxPerson = countMax[1];
            if (countPerson >= maxPerson) {
                button.style.backgroundColor = "red";
                button.style.color = 'white';
                button.style.pointerEvents = "none";
                button.style.cursor = "not-allowed";
                button.style.opacity = "0.6";
            }
        });
    });

    // --------------------------------------------------------------------------------------------------------

    // เช็คจำนวนคนใน Post
    $(document).ready(function () {
        $('.join-room-button').click(function (e) {
            e.preventDefault(); // หยุดการทำงานของลิงก์ปกติ

            var button = $(this); // เก็บการอ้างอิงถึงปุ่มที่คลิก
            var postId = button.data('id');
            var personCountSpan = $('#person-count-' + postId);
            var personCountText = personCountSpan.text();
            var currentCount = parseInt(personCountText.split('/')[0]);
            var maxPerson = parseInt(personCountText.split('/')[1]);
            
            if (!userSession) {
                window.location.href = '/Account/Login';
                return;
            }


            $.ajax({
                url: '@Url.Action("Joinroom", "Post")',
                type: 'POST',
                data: { id: postId, user: '@ViewBag.Usersession' },
                success: function (response) {
                    if (response.success) {
                        var newCount = response.newCount;
                        personCountSpan.text(newCount + '/' + maxPerson);
                        //ตรวจสอบอีกครั้งเพื่ออัปเดตสถานะปุ่ม
                        if (newCount >= maxPerson) {
                            button.css({
                                'background-color': 'red',
                                'color' : 'white',// เปลี่ยนสีพื้นหลังเป็นสีแดง
                                'pointer-events': 'none',      // ป้องกันการคลิก
                                'cursor': 'not-allowed',       // เปลี่ยนเคอร์เซอร์เป็นไม่อนุญาต
                                'opacity': '0.6'               // ทำให้ปุ่มโปร่งแสง
                            });
                        }else{
                            button.css({
                                'pointer-events': 'none',  
                                'color': 'white',// ป้องกันการคลิก
                                'cursor': 'not-allowed',       // เปลี่ยนเคอร์เซอร์เป็นไม่อนุญาต
                                'opacity': '0.6'               // ทำให้ปุ่มโปร่งแสง
                            });
                        }
                    } else {
                        button.css({
                            'pointer-events': 'none',      // ป้องกันการคลิก
                            'color': 'white',
                            'cursor': 'not-allowed',       // เปลี่ยนเคอร์เซอร์เป็นไม่อนุญาต
                            'opacity': '0.6'               // ทำให้ปุ่มโปร่งแสง
                        });
                        return;
                    }
                },
            });
        });
    });


</script>
<script src="~/js/script_Post.js"></script>

